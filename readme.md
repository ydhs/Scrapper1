# Scraper1

**Scraper1** — это простой проект для сбора, хранения и визуализации данных о текущей и прогнозной температуре в указанных городах с веб-интерфейсом и авторизацией.

---

## Содержание

1. [Функции](#функции)
2. [Структура проекта](#структура-проекта)
3. [Установка](#установка)
4. [Настройка](#настройка)
5. [Запуск](#запуск)
6. [Авторизация](#авторизация)
7. [Визуализация](#визуализация)
8. [Структура базы данных](#структура-базы-данных)
9. [Зависимости](#зависимости)

---

## Функции

- `main.py` — инициализация базы данных и сбор данных:
  - читает список городов из `settings.json`
  - парсит текущую температуру и прогноз на завтра (Selenium + BeautifulSoup)
  - сохраняет результаты в SQLite (`weather.db`)
- `parser.py` — логика парсинга Gismeteo:
  - извлечение текущей и прогнозной температуры
- `db.py` — работа с базой данных:
  - создание таблиц при первом запуске
  - добавление и очистка записей
- `analize.py` — визуализация данных за любую дату:
  - принимает дату в формате `dd.mm.YYYY`
  - строит графики текущей и прогнозной температуры
- `api.py` — REST API доступ к температурным данным
- `app.py` — запуск Flask-приложения с API и веб-интерфейсом с поддержкой сессий
- `web.py` — основная логика веб-интерфейса и построения графика
- `templates/` — HTML-шаблоны `login.html` и `web.html`

---

## Структура проекта

```text
Scraper1/
├── main.py              # Сбор данных и запись в БД
├── parser.py            # Парсинг HTML-страниц Gismeteo
├── db.py                # Модуль работы с SQLite
├── analize.py           # Визуализация температур за дату
├── settings.json        # Конфиг городов и URL-адреса
├── auth.json            # Секретный ключ и пользователи для авторизации
├── weather.db           # Файл базы данных (создаётся автоматически)
├── app.py               # Flask-приложение с API и веб-интерфейсом
├── api.py               # Реализация API
├── web.py               # Логика веб-интерфейса и построения графика
├── templates/
│   ├── login.html       # Шаблон страницы входа
│   └── web.html         # Шаблон основного интерфейса
├── static/
│   └── graph.png        # Сгенерированный график
└── requirements.txt     # Зависимости проекта
```

---

## Установка

1. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/ydhs/Scrapper1.git
   cd Scrapper1
   ```
2. Создайте виртуальное окружение и активируйте его:
   ```bash
   python -m venv .venv
   # Windows PowerShell
   .\.venv\Scripts\Activate.ps1
   # Linux/macOS
   source .venv/bin/activate
   ```
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

---

## Настройка

1. **settings.json** — список городов и URL-адресов для парсинга:
   ```json
   {
     "cities": [
       {
         "name": "Новосибирск",
         "now_url": "https://.../now/",
         "forecast_url": "https://.../tomorrow/"
       }
     ]
   }
   ```

2. **auth.json** — создайте рядом с `app.py` и заполните:
   ```json
   {
     "secret_key": "ВАШ_СЕКРЕТ_КЛЮЧ",
     "users": {
       "admin": "пароль123",
       "user1": "pwd456"
     }
   }
   ```
   - `secret_key` используется для подписи сессий Flask
   - `users` хранит пары логин:пароль в открытом виде

> **Важно:** не храните `auth.json` в публичном репозитории.

---

## Запуск

1. **Сбор данных**:
   ```bash
   python main.py
   ```

2. **Визуализация командой** (консольная):
   ```bash
   python analize.py DD.MM.YYYY
   ```

3. **Запуск веб-приложения**:
   ```bash
   python app.py
   ```

4. **Авторизация и веб-интерфейс**:
   - Перейдите в браузере на `http://127.0.0.1:5000/login` и введите учётные данные из `auth.json`.
   - После входа откроется основной интерфейс по адресу `http://127.0.0.1:5000/`, где можно выбрать город и период (день, месяц или год), и получить график.
   - Чтобы выйти из аккаунта, нажмите кнопку **Выход** в навигационной панели.

---

## Авторизация

- Реализована сессийная авторизация через **Flask-Login**.
- Незалогиненный пользователь при обращении к `/` будет перенаправлен на `/login`.
- Страница `/logout` завершает сессию и возвращает на страницу входа.

---

## Визуализация

- Веб-интерфейс создаёт статический график с двумя кривыми:
  - **Текущая** температура (точки)
  - **Прогнозная** температура (крестики, пунктир)
- График сохраняется в `static/graph.png` и отображается в HTML.

---

## Структура базы данных

Используется SQLite-файл `weather.db` с таблицами:

- **cities**:
  - `id` (INTEGER, PK)
  - `name` (TEXT)
  - `url` (TEXT) — уникальный URL парсинга
- **current_temperature**:
  - `id` (INTEGER, PK)
  - `city_id` (INTEGER)
  - `temperature` (REAL)
  - `timestamp` (TEXT)
- **forecast_temperature**:
  - `id` (INTEGER, PK)
  - `city_id` (INTEGER)
  - `timestamp` (TEXT)
  - `temperature` (REAL)

---

## Зависимости

- Python ≥3.x
- selenium
- beautifulsoup4
- pandas
- matplotlib
- flask
- flask-cors
- flask-login
- requests
